<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="color-scheme" content="dark only">
    <title>Palavra na Testa</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* === RESET & VARS === */
        :root {
            --bg-dark: #0f172a;
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #fbbf24;
            --success: #22c55e;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.05);
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        html { background-color: #1e1b4b; background-image: radial-gradient(circle at center, #2e1065 0%, #020617 100%); height: 100%; }
        body { width: 100vw; height: 100vh; overflow: hidden; font-family: 'Poppins', sans-serif; color: white; position: fixed; top: 0; left: 0; }

        /* === UTILS === */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; z-index: 1; opacity: 0; transition: opacity 0.3s ease; }
        .screen.active { display: flex; opacity: 1; z-index: 10; }
        .scrollable { overflow-y: auto; justify-content: flex-start; padding-top: 40px; }

        /* === TYPOGRAPHY === */
        h1 { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: clamp(2.5rem, 6vw, 4.5rem); text-transform: uppercase; background: linear-gradient(to right, #818cf8, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; letter-spacing: -1px; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(99,102,241,0.5)); }
        h2 { font-family: 'Montserrat'; font-size: 1.5rem; margin-bottom: 15px; color: var(--accent); text-transform: uppercase; }

        /* === UI COMPONENTS === */
        .btn { background: linear-gradient(90deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 50px; padding: 18px 40px; font-size: 1.5rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4); transition: transform 0.1s; width: 100%; max-width: 400px; margin: 10px 0; font-family: 'Montserrat'; }
        .btn:active { transform: scale(0.97); }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.3); box-shadow: none; font-size: 1.2rem; }
        .btn-small { padding: 10px 20px; font-size: 1rem; max-width: 200px; margin: 5px; }
        .input-group { margin-bottom: 15px; width: 100%; max-width: 500px; }
        label { display: block; font-size: 0.9rem; color: #cbd5e1; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
        input, textarea { width: 100%; padding: 15px; background: rgba(255,255,255,0.1); border: var(--border); color: white; border-radius: 10px; font-size: 1.2rem; font-family: 'Poppins'; }
        textarea { min-height: 100px; resize: vertical; font-size: 0.9rem; }
        
        /* === TELA INICIAL === */
        #screen-home { gap: 20px; }
        .options-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 30px; padding-bottom: 50px; }
        .section-box { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border: var(--border); }
        .teams-container { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 500px; }

        /* === TELA JOGO === */
        #screen-game { background: black !important; padding: 0; }
        .timer-wrapper { position: absolute; top: 30px; right: 30px; width: 90px; height: 90px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: conic-gradient(var(--secondary) 0deg, #333 0deg); z-index: 20; }
        .timer-wrapper::after { content: ''; position: absolute; inset: 8px; background: black; border-radius: 50%; z-index: 1; }
        .timer-text { position: relative; z-index: 2; font-family: 'Montserrat'; font-size: 2rem; font-weight: 900; }
        #word-disp { font-family: 'Montserrat'; font-weight: 900; font-size: 18vmin; text-align: center; line-height: 0.9; text-transform: uppercase; width: 95%; z-index: 5; }
        .hud-bar { position: absolute; bottom: 40px; width: 90%; display: flex; justify-content: space-between; font-family: 'Montserrat'; font-weight: 800; font-size: 1.5rem; z-index: 10; }
        .hud-left { color: var(--success); } .hud-right { color: var(--danger); }
        .flash { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 15vmin; font-weight: 900; opacity: 0; pointer-events: none; z-index: 50; font-family: 'Montserrat'; }
        .touch-zone { position: absolute; top:0; bottom:0; width: 40%; z-index: 8; } .tz-l { left: 0; } .tz-r { right: 0; }

        /* === SELETOR DE MODO (ROLETA/JACKPOT) === */
        #screen-wheel { 
            flex-direction: row; 
            justify-content: center; /* MantÃ©m tudo no meio da tela */
            gap: 3vw; 
        }

        /* --- COLUNA ESQUERDA (VISUALIZADOR) --- */
        
        /* Roleta Circular */
        #wheel-container { 
            width: 65vmin; height: 65vmin; 
            position: relative; filter: drop-shadow(0 0 30px rgba(0,0,0,0.5)); 
            flex-shrink: 0; /* Impede que encolha */
        }
        #wheel-spinner { width: 100%; height: 100%; border-radius: 50%; position: relative; border: 6px solid white; overflow: hidden; }
        .slice-wrapper { position: absolute; top: 50%; left: 50%; width: 0; height: 0; pointer-events: none; z-index: 10; }
        .slice-text { 
            position: absolute; top: 0; left: 0; transform: translateY(-50%); padding-left: 10vmin; 
            font-family: 'Montserrat'; font-weight: 900; color: white; text-transform: uppercase; white-space: nowrap; text-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }
        #pointer { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); border-left: 30px solid transparent; border-right: 30px solid transparent; border-top: 60px solid white; z-index: 20; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        .wheel-center-cap { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 15%; height: 15%; background: white; border-radius: 50%; box-shadow: 0 0 20px rgba(0,0,0,0.2); z-index: 15; }

        /* Jackpot Vertical (Fixed Width) */
        #jackpot-container { 
            display:none;
            width: 50vmin; height: 50vmin; 
            position: relative; flex-shrink: 0;
            background: rgba(0,0,0,0.3); border-radius: 20px; border: 4px solid white;
            overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
        }
        #jackpot-strip { width: 100%; position: absolute; top: 50%; left: 0; transform: translateY(0px); }
        .jackpot-item {
            height: 12vmin; 
            display: flex; align-items: center; justify-content: center;
            font-family: 'Montserrat'; font-weight: 900; font-size: 3.5vmin;
            text-transform: uppercase; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center; padding: 0 10px;
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .jackpot-arrow { position: absolute; top: 50%; left: -20px; transform: translateY(-50%); border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 30px solid white; z-index: 20; filter: drop-shadow(2px 0 5px rgba(0,0,0,0.5)); }
        .jackpot-arrow-right { left: auto; right: -20px; transform: translateY(-50%) rotate(180deg); }
        .jackpot-highlight { position: absolute; top: 50%; left: 0; width: 100%; height: 12vmin; transform: translateY(-50%); background: rgba(255,255,255,0.1); border-top: 2px solid white; border-bottom: 2px solid white; pointer-events: none; }

        /* --- COLUNA DIREITA (INFO) --- */
        .wheel-info { 
            display: flex; flex-direction: column; 
            align-items: flex-start; justify-content: center; 
            width: 40vw; /* Largura fixa para nÃ£o empurrar a roleta */
            max-width: 400px;
            text-align: left;
        }

        /* Ajuste de texto responsivo */
        #res-cat {
            font-size: 5vh; font-weight: 900; margin-bottom: 2vh; 
            color: #22c55e; text-transform: uppercase; line-height:1.1;
            word-wrap: break-word; /* Quebra linha se for mt longo */
        }

        /* === RESULTADOS === */
        #screen-res, #screen-final { background: #1e1b4b; }

        /* === RESPONSIVO === */
        @media (max-width: 900px) {
            #screen-wheel { flex-direction: column; gap: 20px; }
            .wheel-info { align-items: center; text-align: center; width: 90%; }
            #wheel-container { width: 70vw; height: 70vw; }
            #jackpot-container { width: 70vw; height: 70vw; }
            h1 { font-size: 3rem; }
        }
        #lock { position: fixed; inset: 0; background: #020617; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        @media screen and (orientation: portrait) { 
            #lock { display: flex; } .screen:not(.allow-portrait) { display: none !important; } 
            .allow-portrait { display: flex !important; }
            .allow-portrait ~ #lock { display: none; }
        }
    </style>
</head>
<body>

    <!-- AUDIO -->
    <audio id="snd-click" src="https://assets.mixkit.co/sfx/preview/mixkit-ui-click-2432.mp3"></audio>
    <audio id="snd-spin" src="https://assets.mixkit.co/sfx/preview/mixkit-foley-tire-rolling-looped-1681.mp3" loop></audio>
    <audio id="snd-win" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
    <audio id="snd-ok" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
    <audio id="snd-pass" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

    <div id="lock"><h2 style="margin-top:20px">GIRE A TELA</h2></div>
    <div style="position:absolute; top:20px; left:20px; z-index:100; cursor:pointer; opacity:0.5" onclick="if(confirm('Voltar ao menu?')) location.reload()"><svg width="30" height="30" viewBox="0 0 24 24" fill="white"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div>

    <!-- TELA 0: HOME -->
    <div id="screen-home" class="screen active allow-portrait">
        <h1>PALAVRA NA TESTA</h1>
        <button class="btn" onclick="app.to('teams')">INICIAR JOGO</button>
        <button class="btn btn-outline" onclick="app.to('options')">OPÃ‡Ã•ES / EDITOR</button>
    </div>

    <!-- TELA 0.5: OPÃ‡Ã•ES -->
    <div id="screen-options" class="screen scrollable allow-portrait">
        <h1>OPÃ‡Ã•ES</h1>
        <div class="options-container">
            <div class="section-box">
                <h2>ConfiguraÃ§Ãµes</h2>
                <div class="input-group"><label>Tempo (s)</label><input type="number" id="opt-time" value="60"></div>
                <div class="input-group"><label>Rodadas</label><input type="number" id="opt-rounds" value="3"></div>
            </div>
            <div class="section-box">
                <h2>Google Sheets</h2>
                <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px">Link da Planilha (PÃºblica)</p>
                <div class="input-group"><input type="text" id="sheet-input" placeholder="https://docs.google.com/spreadsheets/d/..." onchange="dataMgr.loadSheet()"></div>
            </div>
            <div class="section-box">
                <h2>Editor Manual</h2>
                <div class="input-group"><textarea id="json-input" placeholder='[{"n":"CAT","w":["A","B"]}]'></textarea></div>
                <div style="display:flex; flex-wrap:wrap; gap:10px">
                    <button class="btn btn-small btn-outline" onclick="dataMgr.copyPrompt()">ðŸ¤– Prompt IA</button>
                    <button class="btn btn-small" onclick="dataMgr.save()">ðŸ’¾ Salvar</button>
                    <button class="btn btn-small btn-outline" onclick="dataMgr.reset()">Resetar</button>
                </div>
            </div>
            <button class="btn" onclick="app.to('home')">VOLTAR</button>
        </div>
    </div>

    <!-- TELA 1: TIMES -->
    <div id="screen-teams" class="screen allow-portrait">
        <h1>EQUIPES</h1>
        <div class="teams-container">
            <div class="input-group"><label style="color: #6366f1;">Time Azul</label><input type="text" id="t1" value="Time Azul" style="border-left: 6px solid #6366f1"></div>
            <div class="input-group"><label style="color: #ec4899;">Time Rosa</label><input type="text" id="t2" value="Time Rosa" style="border-left: 6px solid #ec4899"></div>
        </div>
        <button class="btn" onclick="app.start()">JOGAR AGORA</button>
        <button class="btn btn-outline" onclick="app.to('home')">VOLTAR</button>
    </div>

    <!-- TELA 2: INTRO -->
    <div id="screen-intro" class="screen">
        <h2 style="opacity:0.6; font-size: 3vh;">RODADA <span id="lbl-rd">1</span></h2>
        <h1 id="lbl-tm" style="font-size: 8vh; margin: 2vh 0;">TIME</h1>
        <p style="font-size: 3vh; opacity: 0.8">Celular na testa</p>
        <button class="btn" style="width: auto; margin-top: 4vh;" onclick="app.toWheel()">GIRAR ROLETA</button>
    </div>

    <!-- TELA 3: SELEÃ‡ÃƒO -->
    <div id="screen-wheel" class="screen">
        <!-- MODO ROLETA -->
        <div id="wheel-container">
            <div id="pointer"></div>
            <div id="wheel-spinner"></div>
            <div class="wheel-center-cap"></div>
        </div>
        
        <!-- MODO JACKPOT -->
        <div id="jackpot-container">
            <div class="jackpot-highlight"></div>
            <div class="jackpot-arrow"></div>
            <div class="jackpot-arrow jackpot-arrow-right"></div>
            <div id="jackpot-strip"></div>
        </div>

        <div class="wheel-info">
            <h3 style="color: #fbbf24; font-size: 3vh; text-transform: uppercase; margin-bottom: 1vh;">Categoria</h3>
            <div id="res-cat" style="opacity:0">...</div>
            <button id="btn-go" class="btn" style="display:none" onclick="game.pre()">COMEÃ‡AR</button>
        </div>
    </div>

    <!-- TELA 4: JOGO -->
    <div id="screen-game" class="screen">
        <div class="timer-wrapper"><div class="timer-text" id="timer-num">60</div></div>
        <div id="word-disp">PALAVRA</div>
        <div class="hud-bar"><div class="hud-left">â–¼ ACERTOU</div><div class="hud-right">â–² PULAR</div></div>
        <div class="touch-zone tz-l" onclick="game.act(true)"></div>
        <div class="touch-zone tz-r" onclick="game.act(false)"></div>
        <div id="fb-ok" class="flash" style="background: rgba(34, 197, 94, 0.9);">ACERTOU!</div>
        <div id="fb-no" class="flash" style="background: rgba(239, 68, 68, 0.9);">PULOU!</div>
    </div>

    <!-- TELA 5: RESULTADO -->
    <div id="screen-res" class="screen">
        <h2 style="color:var(--success); font-size: 4vh;">FIM DA RODADA</h2>
        <div id="res-score" style="font-size: 12vh; font-weight: 900; margin: 2vh 0;">0</div>
        <div id="res-list" style="width:100%; max-width:600px; height:30vh; overflow-y:auto; background:rgba(255,255,255,0.1); border-radius:15px; padding:15px;"></div>
        <button class="btn" style="width:auto; margin-top:3vh" onclick="app.next()">PRÃ“XIMO</button>
    </div>

    <!-- TELA 6: FINAL -->
    <div id="screen-final" class="screen">
        <h1 style="font-size: 8vh;">FIM DE JOGO</h1>
        <div style="display:flex; gap:4vw; margin: 4vh 0; flex-wrap: wrap; justify-content: center;">
            <div style="text-align:center; background:rgba(255,255,255,0.1); padding:3vh; border-radius:20px; min-width:20vw">
                <div id="fn-1" style="color:#818cf8; font-weight:bold; font-size: 3vh">Azul</div><div id="fs-1" style="font-size:8vh; font-weight:900">0</div>
            </div>
            <div style="text-align:center; background:rgba(255,255,255,0.1); padding:3vh; border-radius:20px; min-width:20vw">
                <div id="fn-2" style="color:#f472b6; font-weight:bold; font-size: 3vh">Rosa</div><div id="fs-2" style="font-size:8vh; font-weight:900">0</div>
            </div>
        </div>
        <h2 id="winner" style="color:var(--accent); font-size: 4vh;">VENCEDOR</h2>
        <button class="btn" style="width:auto; margin-top: 3vh;" onclick="location.reload()">MENU PRINCIPAL</button>
    </div>

    <script>
        const COLORS = ["#ef4444", "#f97316", "#eab308", "#22c55e", "#06b6d4", "#3b82f6", "#8b5cf6", "#ec4899"];
        const DEFAULT_CATS = [
            {n:"ANIMAIS", w:["Gato","Cachorro","Elefante","Girafa","LeÃ£o","TubarÃ£o","Panda","Zebra","Macaco"]},
            {n:"FILMES", w:["Titanic","Avatar","Matrix","Shrek","Barbie","Batman","Frozen","Vingadores","Coringa"]},
            {n:"OBJETOS", w:["Mesa","Cadeira","Celular","Espelho","SofÃ¡","Copo","RelÃ³gio","Sapato","Computador"]},
            {n:"AÃ‡Ã•ES", w:["Correr","DanÃ§ar","Nadar","Dormir","Comer","Beijar","Gritar","Chorar","Pular"]},
            {n:"FAMOSOS", w:["Neymar","Anitta","Messi","BeyoncÃ©","Xuxa","PelÃ©","Madonna","Silvio Santos"]},
            {n:"LUGARES", w:["Praia","Escola","Shopping","Cinema","Hospital","Igreja","Parque","Banco"]},
            {n:"ESPORTES", w:["Futebol","VÃ´lei","Basquete","TÃªnis","NataÃ§Ã£o","JudÃ´","Boxe","Golfe"]},
            {n:"CORES", w:["Azul","Vermelho","Verde","Amarelo","Roxo"]},
            {n:"JOGADORES DE FUTEBOL", w:["Messi", "Neymar", "CR7", "PelÃ©", "Maradona"]},
            {n:"SÃ‰RIES", w:["Friends", "Lost", "Breaking Bad", "GoT", "The Office"]},
            {n:"COMIDAS", w:["Pizza", "Hamburguer", "Sushi", "Pastel", "Coxinha"]},
            {n:"PLANTAS", w:["Rosa", "Girassol", "Cacto", "OrquÃ­dea", "Samambaia"]},
            {n:"TECNOLOGIA", w:["iPhone", "Android", "Windows", "Linux", "Wifi"]}
        ];
        
        let CURRENT_CATS = JSON.parse(JSON.stringify(DEFAULT_CATS));
        const aud = { p:(i)=>{document.getElementById('snd-'+i).play().catch(()=>{})}, l:(i,o)=>{const a=document.getElementById('snd-'+i); o?a.play().catch(()=>{}):a.pause()} };
        const st = { t:[{n:"",s:0,c:"#6366f1"},{n:"",s:0,c:"#ec4899"}], cfg:{t:60,r:3}, rd:1, trn:0, cat:null, q:[], skp:[], h:[], pts:0, on:false };

        function smartSplit(text) {
            if (text.length <= 10) return { text: text, lines: 1 };
            const words = text.split(' ');
            if (words.length === 1) return { text: text, lines: 1 };
            let bestIdx = 0, minDiff = Infinity, currentLen = 0, totalLen = text.length;
            for(let i=0; i<words.length-1; i++) {
                currentLen += words[i].length;
                const diff = Math.abs(currentLen - (totalLen - currentLen));
                if(diff < minDiff) { minDiff = diff; bestIdx = i; }
            }
            return { text: `${words.slice(0, bestIdx+1).join(' ')}<br>${words.slice(bestIdx+1).join(' ')}`, lines: 2, maxLen: Math.max(words.slice(0, bestIdx+1).join(' ').length, words.slice(bestIdx+1).join(' ').length) };
        }

        const dataMgr = {
            init: () => { document.getElementById('json-input').value = JSON.stringify(CURRENT_CATS, null, 2); },
            save: () => { try { CURRENT_CATS = JSON.parse(document.getElementById('json-input').value); alert("Salvo!"); } catch(e) { alert("Erro JSON"); } },
            reset: () => { CURRENT_CATS = JSON.parse(JSON.stringify(DEFAULT_CATS)); dataMgr.init(); alert("Resetado!"); },
            copyPrompt: () => { navigator.clipboard.writeText("Gere JSON: [{\"n\":\"CAT\", \"w\":[\"A\",\"B\"]}]").then(()=>alert("Copiado!")); },
            loadSheet: () => {
                const url = document.getElementById('sheet-input').value;
                if(!url.includes('docs.google.com')) return;
                const id = url.match(/\/d\/(.*?)\//)[1];
                // USA GVIZ API PARA EVITAR PROBLEMAS DE EXPORT
                const gviz = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv`;
                fetch(gviz).then(r=>r.text()).then(csv=>{
                    const rows = csv.split('\n').map(r=>r.split(','));
                    const newCats = [];
                    for(let c=0; c<rows[0].length; c++) {
                        const name = rows[0][c].replace(/"/g,'').trim();
                        if(!name) continue;
                        const w = [];
                        for(let r=1; r<rows.length; r++) {
                            if(rows[r] && rows[r][c]) {
                                const word = rows[r][c].replace(/"/g,'').trim();
                                if(word) w.push(word);
                            }
                        }
                        if(w.length) newCats.push({n:name, w:w});
                    }
                    if(newCats.length){ CURRENT_CATS=newCats; alert("Carregado com sucesso!"); }
                }).catch(e=>alert("Erro! Verifique se a planilha Ã© pÃºblica (Qualquer um com link)."));
            }
        };

        const sensor = {
            z: 0, wait: false,
            init: () => { if (window.DeviceMotionEvent) window.addEventListener('devicemotion', sensor.handle); },
            handle: (e) => {
                const acc = e.accelerationIncludingGravity; if (!acc) return;
                sensor.z = acc.z || 0;
                if (st.on && !sensor.wait) {
                    if (sensor.z < -8.0) { game.act(true); sensor.pause(); }
                    else if (sensor.z > 8.0) { game.act(false); sensor.pause(); }
                }
            },
            pause: () => { sensor.wait = true; setTimeout(() => sensor.wait = false, 1500); }
        };
        sensor.init();

        const app = {
            to: (id) => {
                document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
                document.getElementById('screen-'+id).classList.add('active');
                if(id === 'options') dataMgr.init();
            },
            start: () => {
                aud.p('click');
                if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().catch(()=>{});
                }
                st.t[0].n = document.getElementById('t1').value; st.t[1].n = document.getElementById('t2').value;
                st.cfg.t = parseInt(document.getElementById('opt-time').value); st.cfg.r = parseInt(document.getElementById('opt-rounds').value);
                app.prep();
            },
            prep: () => {
                if(st.rd > st.cfg.r) { app.end(); return; }
                const t = st.t[st.trn];
                document.getElementById('lbl-rd').innerText = st.rd;
                document.getElementById('lbl-tm').innerText = t.n;
                document.getElementById('lbl-tm').style.color = t.c;
                app.to('intro');
            },
            toWheel: () => { aud.p('click'); wheel.init(); app.to('wheel'); },
            next: () => { aud.p('click'); st.trn++; if(st.trn>1){st.trn=0; st.rd++} app.prep(); },
            end: () => {
                const t1=st.t[0], t2=st.t[1];
                document.getElementById('fn-1').innerText=t1.n; document.getElementById('fs-1').innerText=t1.s;
                document.getElementById('fn-2').innerText=t2.n; document.getElementById('fs-2').innerText=t2.s;
                const w=document.getElementById('winner');
                if(t1.s>t2.s) {w.innerText=t1.n+" VENCEU!"; w.style.color=t1.c;}
                else if(t2.s>t1.s) {w.innerText=t2.n+" VENCEU!"; w.style.color=t2.c;}
                else {w.innerText="EMPATE"; w.style.color="white";}
                aud.p('win'); app.to('final');
            }
        };

        const wheel = {
            el: document.getElementById('wheel-spinner'),
            jackpot: document.getElementById('jackpot-strip'),
            mode: 'wheel',
            ang: 0, offsetY: 0, spin: false, velocity: 0, lastPos: 0, lastTime: 0,
            
            init: () => {
                wheel.mode = CURRENT_CATS.length > 12 ? 'jackpot' : 'wheel';
                document.getElementById('wheel-container').style.display = wheel.mode === 'wheel' ? 'block' : 'none';
                document.getElementById('jackpot-container').style.display = wheel.mode === 'jackpot' ? 'block' : 'none';
                document.getElementById('btn-go').style.display='none'; 
                document.getElementById('res-cat').innerText = "..."; document.getElementById('res-cat').style.opacity=0;
                wheel.spin = false;

                if (wheel.mode === 'wheel') wheel.setupWheel();
                else wheel.setupJackpot();
                
                wheel.attachEvents();
            },

            setupWheel: () => {
                let g="conic-gradient(", h=""; const count = CURRENT_CATS.length; const sliceDeg = 360 / count;
                CURRENT_CATS.forEach((c, i) => {
                    const color = COLORS[i % COLORS.length];
                    const start = i * sliceDeg; const end = (i + 1) * sliceDeg;
                    g += `${color} ${start}deg ${end}deg,`;
                    const mid = start + (sliceDeg / 2);
                    const split = smartSplit(c.n);
                    let fontSize = 3.5; const refLen = split.lines === 1 ? c.n.length : split.maxLen;
                    if(refLen > 8) fontSize = 3.5 * (8 / refLen);
                    h += `<div class="slice-wrapper" style="transform:rotate(${mid - 90}deg)"><span class="slice-text" style="font-size:${fontSize}vmin">${split.text}</span></div>`;
                });
                wheel.el.style.background = g.slice(0, -1) + ")"; wheel.el.innerHTML = h;
                wheel.ang = -(sliceDeg / 2); wheel.el.style.transform = `rotate(${wheel.ang}deg)`;
            },

            setupJackpot: () => {
                let h = "";
                const list = [...CURRENT_CATS, ...CURRENT_CATS, ...CURRENT_CATS]; // Triplica para loop
                list.forEach((c, i) => {
                     const color = COLORS[i % COLORS.length];
                     h += `<div class="jackpot-item" style="background:${color}">${c.n}</div>`;
                });
                wheel.jackpot.innerHTML = h;
                wheel.offsetY = 0; wheel.jackpot.style.transform = `translateY(0px)`;
            },

            attachEvents: () => {
                const target = wheel.mode === 'wheel' ? document.getElementById('wheel-container') : document.getElementById('jackpot-container');
                const track = (pos) => {
                    const now=Date.now(); const delta = pos - wheel.lastPos; const dt=now-wheel.lastTime;
                    if (wheel.mode === 'wheel') {
                        wheel.ang += delta * 0.5; 
                        wheel.el.style.transform = `rotate(${wheel.ang}deg)`;
                    } else {
                        wheel.offsetY += delta;
                        wheel.jackpot.style.transform = `translateY(${wheel.offsetY}px)`;
                    }
                    if(dt>0) wheel.velocity = (delta/dt) * 15;
                    wheel.lastPos = pos; wheel.lastTime = now;
                };
                const start = (pos) => { if(wheel.spin)return; wheel.lastPos=pos; wheel.lastTime=Date.now(); wheel.velocity=0; };
                const end = () => { if(wheel.spin)return; if(Math.abs(wheel.velocity)>0.5) wheel.go(wheel.velocity); };
                
                target.ontouchstart = e => start(e.touches[0].clientY);
                target.ontouchmove = e => { e.preventDefault(); track(e.touches[0].clientY); };
                target.ontouchend = end;
                target.onmousedown = e => { start(e.clientY); target.onmousemove = ev => track(ev.clientY); };
                window.onmouseup = () => { target.onmousemove = null; end(); };
            },

            go: (v) => {
                wheel.spin=true; aud.l('spin',true);
                let vel = v || 20; 
                if(vel>40) vel=40; if(vel<-40) vel=-40; if(Math.abs(vel)<5) vel = 10 * (Math.random()<0.5?-1:1);

                const loop=()=>{
                    if(!wheel.spin) return;
                    vel *= 0.98;
                    
                    if (wheel.mode === 'wheel') {
                        wheel.ang += vel;
                        wheel.el.style.transform = `rotate(${wheel.ang}deg)`;
                    } else {
                        wheel.offsetY += vel * 5;
                        const stripH = wheel.jackpot.clientHeight / 3; 
                        if (wheel.offsetY > 0) wheel.offsetY -= stripH;
                        if (wheel.offsetY < -stripH * 2) wheel.offsetY += stripH;
                        wheel.jackpot.style.transform = `translateY(${wheel.offsetY}px)`;
                    }
                    
                    if(Math.abs(vel)<0.05) {
                        wheel.spin=false; aud.l('spin',false);
                        wheel.finish();
                    } else requestAnimationFrame(loop);
                }
                loop();
            },

            finish: () => {
                let cat, idx;
                if (wheel.mode === 'wheel') {
                    const norm = (wheel.ang % 360 + 360) % 360;
                    const winAngle = (360 - norm) % 360;
                    const sliceDeg = 360 / CURRENT_CATS.length;
                    idx = Math.floor(winAngle / sliceDeg);
                } else {
                    // LÃ³gica Exata do Jackpot:
                    // O item altura Ã© 12vmin. O offset Ã© negativo (subindo).
                    // O highlight estÃ¡ no centro (top: 50%).
                    // Convertendo vmin para pixels para cÃ¡lculo
                    const vmin = Math.min(window.innerWidth, window.innerHeight) / 100;
                    const itemH = 12 * vmin; 
                    const containerH = 50 * vmin; 
                    
                    // O "centro" estÃ¡ em 25vmin (metade de 50vmin).
                    // A posiÃ§Ã£o atual do topo da fita Ã© `wheel.offsetY`.
                    // A posiÃ§Ã£o de um item i Ã© `wheel.offsetY + i * itemH`.
                    // Queremos saber qual item estÃ¡ cobrindo o ponto 25vmin.
                    // 25vmin = offsetY + i * itemH + itemH/2
                    // i = (25vmin - offsetY - itemH/2) / itemH
                    
                    const centerLine = containerH / 2;
                    const relativeY = centerLine - wheel.offsetY; // PosiÃ§Ã£o relativa na fita
                    let rawIndex = Math.floor(relativeY / itemH);
                    
                    // Ajuste fino (Snap)
                    const targetY = -(rawIndex * itemH) + centerLine - (itemH/2);
                    wheel.jackpot.style.transition = "transform 0.3s ease-out";
                    wheel.jackpot.style.transform = `translateY(${targetY}px)`;
                    setTimeout(() => wheel.jackpot.style.transition = "none", 300);

                    // Mapeia para array original
                    idx = rawIndex % CURRENT_CATS.length;
                    if(idx < 0) idx += CURRENT_CATS.length;
                }
                
                cat = CURRENT_CATS[idx];
                st.cat = cat;
                const el = document.getElementById('res-cat');
                el.innerText = cat.n; 
                el.style.color = COLORS[idx % COLORS.length];
                el.style.opacity = 1;
                
                aud.p('win'); 
                document.getElementById('btn-go').style.display='inline-block';
            }
        };

        const game = {
            tmr: null,
            pre: () => {
                app.to('game'); const d=document.getElementById('word-disp'); let c=3; d.innerText=c; 
                const i=setInterval(()=>{ c--; if(c>0) d.innerText=c; else { clearInterval(i); d.innerText="VAI!"; setTimeout(game.run, 600); } },1000);
            },
            run: () => {
                st.on=true; st.pts=0; st.h=[]; st.skp=[]; st.q = [...st.cat.w].sort(()=>Math.random()-0.5);
                game.next();
                let totalT=st.cfg.t; let t=totalT;
                const tn=document.getElementById('timer-num'); const tw=document.querySelector('.timer-wrapper');
                
                game.tmr = setInterval(()=>{
                    t--; tn.innerText=t;
                    const pct=((totalT-t)/totalT)*360;
                    tw.style.background=`conic-gradient(var(--secondary) ${pct}deg, #333 ${pct}deg)`;
                    if(t<=0) game.end();
                },1000);
            },
            next: () => {
                if(st.q.length === 0) {
                    if(st.skp.length > 0) { st.q = [...st.skp].sort(()=>Math.random()-0.5); st.skp = []; } 
                    else { game.end(); return; }
                }
                st.cw = st.q.pop(); document.getElementById('word-disp').innerText = st.cw;
            },
            act: (win) => {
                if(!st.on) return;
                if(win){ aud.p('ok'); st.pts++; st.h.push({w:st.cw,ok:true}); game.flash('fb-ok'); }
                else { aud.p('pass'); st.h.push({w:st.cw,ok:false}); game.flash('fb-no'); st.skp.push(st.cw); }
                game.next();
            },
            flash: (id) => { const e=document.getElementById(id); e.style.opacity=1; setTimeout(()=>e.style.opacity=0,600); },
            end: () => {
                st.on=false; clearInterval(game.tmr);
                st.t[st.trn].s += st.pts; document.getElementById('res-score').innerText=st.pts;
                const l=document.getElementById('res-list'); l.innerHTML="";
                st.h.forEach(x=>{
                    const d=document.createElement('div');
                    d.innerHTML=`<b style="color:${x.ok?'#22c55e':'#ef4444'}">${x.ok?'âœ“':'âœ—'}</b> ${x.w}`;
                    d.style.padding="10px"; d.style.borderBottom="1px solid rgba(255,255,255,0.1)"; l.appendChild(d);
                });
                app.to('res');
            }
        };
    </script>
</body>
</html>
