<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="color-scheme" content="dark only">
    <title>Palavra na Testa</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* === VARS & RESET === */
        :root {
            --bg-dark: #0f172a;
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #fbbf24;
            --success: #22c55e;
            --danger: #ef4444;
            --border: 1px solid rgba(255, 255, 255, 0.15);
            /* VariÃ¡veis de SeguranÃ§a para iOS */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }

        html {
            background-color: #1e1b4b;
            background-image: radial-gradient(circle at center, #2e1065 0%, #020617 100%);
            height: 100%;
        }

        body {
            width: 100vw; 
            height: 100dvh; 
            overflow: hidden;
            font-family: 'Poppins', sans-serif; color: white;
            background: transparent;
            position: fixed; top: 0; left: 0;
            padding-top: var(--safe-top);
            padding-bottom: 0; 
            padding-left: var(--safe-left);
            padding-right: var(--safe-right);
        }

        /* === UTILS === */
        .screen {
            position: absolute; inset: 0;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 2vh 4vw; z-index: 1; opacity: 0; transition: opacity 0.3s ease;
            width: 100%; height: 100%;
            overflow-y: auto; 
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .screen.active { display: flex; opacity: 1; z-index: 10; }
        
        #screen-game { overflow: hidden; touch-action: none; justify-content: center; }
        #screen-wheel { overflow: hidden !important; touch-action: none; }

        @media (max-height: 850px) {
            .screen:not(#screen-game):not(#screen-wheel) {
                justify-content: flex-start;
                padding-top: 40px;
                padding-bottom: calc(var(--safe-bottom) + 80px); 
            }
            h1 { 
                font-size: clamp(2rem, 8vw, 3rem) !important; 
                margin-top: 10px;
                margin-bottom: 20px !important;
                flex-shrink: 0;
            }
            .btn { flex-shrink: 0; margin-top: auto; margin-bottom: 10px; }
        }

        .scrollable { justify-content: flex-start; padding-top: 40px; padding-bottom: 120px; }
        .hidden { display: none !important; }

        /* === TYPOGRAPHY === */
        h1 {
            font-family: 'Montserrat', sans-serif; font-weight: 900; 
            font-size: clamp(2rem, 6vw, 4rem); text-transform: uppercase; 
            background: linear-gradient(to right, #818cf8, #f472b6);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-align: center; letter-spacing: -1px; margin-bottom: 2vh;
            filter: drop-shadow(0 0 20px rgba(99,102,241,0.5));
            line-height: 1.1;
            width: 100%;
        }
        h2 { font-family: 'Montserrat'; font-size: 1.5rem; margin-bottom: 15px; color: var(--accent); text-transform: uppercase; }

        /* === ROUND INDICATOR === */
        .round-pill {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 30px;
            border-radius: 50px;
            margin-bottom: 2vh;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .round-pill h2 { margin: 0; font-size: 2.5vh; color: #cbd5e1; letter-spacing: 2px; }
        .round-pill span { font-size: 4vh; font-weight: 900; color: white; line-height: 1; }

        /* === UI COMPONENTS === */
        .btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white; border: none; border-radius: 50px;
            padding: 1.5vh 4vw; font-size: clamp(1.2rem, 2.5vh, 1.5rem); font-weight: 900;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
            transition: transform 0.1s; width: 100%; max-width: 400px; margin: 1vh 0;
            font-family: 'Montserrat';
            min-height: 55px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.3); box-shadow: none; font-size: 1.2rem; }
        .btn-small { padding: 10px 20px; font-size: 0.9rem; max-width: 200px; margin: 5px; height: 40px; display: inline-flex; align-items: center; justify-content: center;}
        .btn-danger { background: var(--danger); box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4); }

        .input-group { margin-bottom: 1.5vh; width: 100%; max-width: 600px; position: relative; flex-shrink: 0; }
        .input-row { display: flex; gap: 10px; width: 100%; max-width: 600px; align-items: flex-end; margin-bottom: 15px; }
        
        label { display: block; font-size: clamp(0.8rem, 2vh, 1rem); color: #cbd5e1; font-weight: 700; margin-bottom: 0.5vh; text-transform: uppercase; }
        input, textarea, select {
            width: 100%; padding: 1.5vh; background: rgba(255,255,255,0.1); 
            border: var(--border); color: white; border-radius: 12px; 
            font-size: clamp(1rem, 2.5vh, 1.2rem); font-family: 'Poppins'; font-weight: 600;
        }
        select { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; }
        textarea { min-height: 150px; resize: vertical; font-size: 0.9rem; font-family: monospace; }

        /* === TABLE EDITOR === */
        #editor-container { width: 100%; }
        .editor-view { display: none; width: 100%; }
        .editor-view.active { display: block; }
        .table-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .table-input-cat { flex: 0 0 140px; font-weight: bold; color: var(--accent); }
        .table-input-words { flex: 1; font-size: 0.9rem; }
        .btn-del { background: var(--danger); width: 40px; height: 40px; padding: 0; font-size: 1.2rem; border-radius: 10px; box-shadow: none; margin: 0; display: flex; align-items: center; justify-content: center; }
        
        /* === MODAL === */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #1e1b4b; border: 1px solid rgba(255,255,255,0.2);
            padding: 30px; 
            border-radius: 20px; text-align: center;
            width: 95%; max-width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: popIn 0.3s ease-out;
            margin-bottom: 20px;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { font-family: 'Montserrat'; font-size: 1.5rem; color: var(--accent); margin-bottom: 10px; }
        .modal-msg { margin-bottom: 30px; font-size: 1.2rem; line-height: 1.5; color: white; }
        .modal-actions { display: flex; gap: 15px; justify-content: center; width: 100%; padding: 10px; }
        #result-cat-display {
            font-size: 3rem; font-weight: 900; color: white; 
            margin: 10px 0 30px 0; text-transform: uppercase;
            text-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* === TELA INICIAL === */
        #screen-home { gap: 2vh; }
        .options-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 30px; padding-bottom: 50px; }
        .section-box { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border: var(--border); }
        .teams-container { display: flex; flex-direction: column; gap: 1.5vh; width: 100%; max-width: 600px; justify-content: center; margin-bottom: 2vh; }

        /* === TELA JOGO === */
        #screen-game { background: transparent; padding: 0; }
        .timer-wrapper {
            position: absolute; top: 3vh; right: 3vh; width: 12vh; height: 12vh; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: conic-gradient(var(--secondary) 0deg, #333 0deg); z-index: 20;
        }
        .timer-wrapper::after { content: ''; position: absolute; inset: 10%; background: #1e1b4b; border-radius: 50%; z-index: 1; }
        .timer-text { position: relative; z-index: 2; font-family: 'Montserrat'; font-size: 5vh; font-weight: 900; }

        #word-disp {
            font-family: 'Montserrat'; font-weight: 900; 
            font-size: clamp(3rem, 18vmin, 8rem);
            text-align: center; line-height: 0.9; text-transform: uppercase;
            width: 90%; z-index: 5; word-wrap: break-word;
        }

        .hud-bar {
            position: absolute; bottom: 3vh; width: 90%; display: flex; justify-content: space-between;
            font-family: 'Montserrat'; font-weight: 800; font-size: 3vh; z-index: 10;
        }
        .hud-left { color: var(--success); }
        .hud-right { color: var(--danger); }

        .flash { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 15vmin; font-weight: 900; opacity: 0; pointer-events: none; z-index: 50; font-family: 'Montserrat'; }
        .touch-zone { position: absolute; top:0; bottom:0; width: 40%; z-index: 8; } .tz-l { left: 0; } .tz-r { right: 0; }

        /* === SELETOR: LAYOUT DUAL === */
        #screen-wheel { flex-direction: row; gap: 5vw; }
        .wheel-info { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; min-width: 300px; text-align: left; }
        
        #res-cat {
            font-size: 5vh; font-weight: 900; margin-bottom: 2vh; 
            color: #22c55e; text-transform: uppercase; line-height:1.1;
            word-wrap: break-word;
        }

        /* 1. ESTILO ROLETA */
        #wheel-container { display:none; width: 85vh; height: 85vh; position: relative; filter: drop-shadow(0 0 30px rgba(0,0,0,0.5)); flex-shrink: 0; }
        #wheel-spinner { width: 100%; height: 100%; border-radius: 50%; position: relative; border: 6px solid white; overflow: hidden; }
        .slice-wrapper { position: absolute; top: 50%; left: 50%; width: 0; height: 0; pointer-events: none; z-index: 10; }
        .slice-text { 
            position: absolute; top: 0; left: 0; transform: translateY(-50%); 
            padding-left: 16vh; /* MARGEM AFASTADA DO CENTRO */
            font-family: 'Montserrat'; font-weight: 900; color: white; text-transform: uppercase; white-space: nowrap; text-shadow: 0 2px 5px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; line-height: 0.95; font-size: 3.5vh;
        }
        #pointer { position: absolute; top: -3vh; left: 50%; transform: translateX(-50%); border-left: 4vh solid transparent; border-right: 4vh solid transparent; border-top: 8vh solid white; z-index: 20; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        .wheel-center-cap { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 20%; height: 20%; background: white; border-radius: 50%; box-shadow: 0 0 20px rgba(0,0,0,0.2); z-index: 15; }

        /* 2. ESTILO JACKPOT */
        #jackpot-container { 
            display:none; width: 85vh; height: 85vh; 
            position: relative; flex-shrink: 0;
            background: rgba(0,0,0,0.3); border-radius: 20px; border: 4px solid white;
            overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
        }
        #jackpot-strip { width: 100%; position: absolute; top: 0; left: 0; transform: translateY(0px); will-change: transform; }
        .jackpot-item {
            height: 15vh; /* Altura definida no CSS */
            display: flex; align-items: center; justify-content: center;
            font-family: 'Montserrat'; font-weight: 900; font-size: 5vh;
            text-transform: uppercase; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center; padding: 0 10px;
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .jackpot-highlight { position: absolute; top: 50%; left: 0; width: 100%; height: 15vh; transform: translateY(-50%); background: rgba(255,255,255,0.1); border-top: 2px solid white; border-bottom: 2px solid white; pointer-events: none; }
        .jackpot-arrow { position: absolute; top: 50%; left: -20px; transform: translateY(-50%); border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 30px solid white; z-index: 20; filter: drop-shadow(2px 0 5px rgba(0,0,0,0.5)); }
        .jackpot-arrow-right { left: auto; right: -20px; transform: translateY(-50%) rotate(180deg); }

        /* === RESULTADOS === */
        #screen-res, #screen-final { background: #1e1b4b; }

        /* === RESPONSIVO === */
        @media (max-width: 900px) {
            #screen-wheel { flex-direction: column; gap: 20px; }
            .wheel-info { align-items: center; text-align: center; width: 90%; }
            #wheel-container { width: 85vw; height: 85vw; }
            #jackpot-container { width: 85vw; height: 85vw; }
            h1 { font-size: 2.5rem; }
        }
        @media (orientation: landscape) {
            #wheel-container { width: 85vh; height: 85vh; }
            #jackpot-container { width: 85vh; height: 85vh; }
            .slice-text { padding-left: 17vh; font-size: 3.5vh; }
        }

        /* Lock & Version */
        #lock { position: fixed; inset: 0; background: #020617; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .rotate-phone-icon { width: 80px; height: 80px; fill: white; animation: rotateAnim 2s infinite ease-in-out; }
        @keyframes rotateAnim { 0% { transform: rotate(0deg); } 30% { transform: rotate(-90deg); } 70% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
        .version-tag { margin-top: 20px; opacity: 0.3; font-family: monospace; font-size: 14px; letter-spacing: 2px; }

        @media screen and (orientation: portrait) { 
            #lock { display: flex; } .screen:not(.allow-portrait) { display: none !important; } 
            .allow-portrait { display: flex !important; }
            .allow-portrait ~ #lock { display: none; }
        }
    </style>
</head>
<body>

    <!-- MODAL -->
    <div id="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-title">AtenÃ§Ã£o</div>
            <div class="modal-msg" id="modal-msg">Mensagem</div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>

    <!-- AUDIO -->
    <audio id="snd-click" src="https://assets.mixkit.co/sfx/preview/mixkit-ui-click-2432.mp3"></audio>
    <audio id="snd-spin" src="https://assets.mixkit.co/sfx/preview/mixkit-foley-tire-rolling-looped-1681.mp3" loop></audio>
    <audio id="snd-win" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
    <audio id="snd-ok" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
    <audio id="snd-pass" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

    <div id="lock">
        <svg class="rotate-phone-icon" viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg>
        <h2 style="margin-top:20px">GIRE A TELA</h2>
        <div class="version-tag">v22.6</div>
    </div>
    
    <!-- HOME ICON -->
    <div id="home-btn" style="position:absolute; top:20px; left:20px; z-index:100; cursor:pointer; opacity:0.5; display: none;" onclick="app.tryHome()">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="white"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    </div>

    <!-- TELA 0: HOME -->
    <div id="screen-home" class="screen active allow-portrait">
        <h1>PALAVRA NA TESTA</h1>
        <button class="btn" onclick="app.start()">INICIAR JOGO</button>
        <button class="btn btn-outline" onclick="app.to('options')">OPÃ‡Ã•ES / EDITOR</button>
    </div>

    <!-- TELA 0.5: OPÃ‡Ã•ES -->
    <div id="screen-options" class="screen scrollable allow-portrait">
        <h1>OPÃ‡Ã•ES</h1>
        <div class="options-container">
            <div class="section-box">
                <h2>ConfiguraÃ§Ãµes</h2>
                <div class="input-group"><label>Tempo (s)</label><input type="number" id="opt-time" value="60" onchange="storage.save()"></div>
                <div class="input-group"><label>Rodadas</label><input type="number" id="opt-rounds" value="3" onchange="storage.save()"></div>
            </div>
            
            <!-- SEÃ‡ÃƒO: MODO DE SORTEIO -->
            <div class="section-box">
                <h2>Modo de Sorteio</h2>
                <div class="input-group">
                    <label>Estilo</label>
                    <select id="opt-mode" onchange="app.toggleThresholdVisibility(); storage.save()">
                        <option value="auto">AutomÃ¡tico (Misto)</option>
                        <option value="wheel">Sempre Roleta</option>
                        <option value="jackpot">Sempre Jackpot</option>
                    </select>
                </div>
                <div class="input-group" id="group-threshold">
                    <label>Limite para Jackpot (Auto)</label>
                    <input type="number" id="opt-threshold" value="12" onchange="storage.save()">
                    <p style="font-size:0.7rem; color:#aaa; margin-top:5px">Se houver mais categorias que esse nÃºmero, usa Jackpot.</p>
                </div>
            </div>

            <div class="section-box">
                <h2>Google Sheets</h2>
                <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px">Link da Planilha (PÃºblica).</p>
                <div class="input-row">
                    <input type="text" id="sheet-input" placeholder="https://docs.google.com/spreadsheets/...">
                    <button class="btn btn-small" style="background: #22c55e;" onclick="dataMgr.loadSheet()">CARREGAR</button>
                </div>
                <!-- NOVO BOTÃƒO CARREGAR PADRÃƒO -->
                <button class="btn btn-small btn-outline" style="width:100%; margin-top:5px" onclick="dataMgr.loadDefault()">CARREGAR PADRÃƒO</button>
            </div>
            <div class="section-box">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                    <h2 style="margin:0">Editor</h2>
                    <button class="btn btn-small btn-outline" id="btn-toggle-view" onclick="dataMgr.toggleView()">Alternar Tabela/JSON</button>
                </div>
                
                <!-- SELETOR DE ABAS -->
                <div class="input-group" style="margin-bottom: 10px;">
                    <label>Aba (Tab)</label>
                    <select id="sheet-selector" onchange="dataMgr.switchSheet(this.value)"></select>
                </div>

                <div id="editor-container">
                    <div id="view-table" class="editor-view active">
                        <div id="table-rows"></div>
                        <button class="btn btn-small btn-outline" style="width:100%; margin-top:10px" onclick="dataMgr.addTableRow()">+ Nova Categoria</button>
                    </div>
                    <div id="view-json" class="editor-view">
                        <div class="input-group"><textarea id="json-input" oninput="dataMgr.markDirty()"></textarea></div>
                    </div>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:20px">
                    <button class="btn btn-small btn-outline" onclick="dataMgr.copyPrompt()">ðŸ¤– Prompt IA</button>
                    <button class="btn btn-small" onclick="dataMgr.save()">ðŸ’¾ Salvar Tudo</button>
                    <button class="btn btn-small btn-outline" onclick="dataMgr.reset()">Resetar</button>
                </div>
            </div>
            <button class="btn" onclick="app.to('home')">VOLTAR</button>
        </div>
    </div>

    <!-- TELA 1: TIMES -->
    <div id="screen-teams" class="screen allow-portrait">
        <h1>EQUIPES</h1>
        <div class="teams-container">
            <div class="input-group"><label style="color: #6366f1;">Time Azul</label><input type="text" id="t1" value="Time Azul" style="border-left: 6px solid #6366f1" onchange="storage.save()"></div>
            <div class="input-group"><label style="color: #ec4899;">Time Rosa</label><input type="text" id="t2" value="Time Rosa" style="border-left: 6px solid #ec4899" onchange="storage.save()"></div>
        </div>
        <button class="btn" onclick="app.confirmTeams()">JOGAR AGORA</button>
    </div>

    <!-- TELA 2: INTRO -->
    <div id="screen-intro" class="screen">
        <div class="round-pill">
            <h2>RODADA</h2>
            <span id="lbl-rd">1</span>
        </div>
        <h1 id="lbl-tm" style="font-size: 8vh; margin: 2vh 0;">TIME</h1>
        <p style="font-size: 3vh; opacity: 0.8">Celular na testa</p>
        <button class="btn" style="width: auto; margin-top: 4vh;" onclick="app.toWheel()">SORTEAR TEMA</button>
    </div>

    <!-- TELA 3: SELEÃ‡ÃƒO -->
    <div id="screen-wheel" class="screen">
        <div id="wheel-container">
            <div id="pointer"></div>
            <div id="wheel-spinner"></div>
            <div class="wheel-center-cap"></div>
        </div>
        <div id="jackpot-container">
            <div class="jackpot-highlight"></div>
            <div class="jackpot-arrow"></div>
            <div class="jackpot-arrow jackpot-arrow-right"></div>
            <div id="jackpot-strip"></div>
        </div>
    </div>

    <!-- TELA 4: JOGO -->
    <div id="screen-game" class="screen">
        <div class="timer-wrapper"><div class="timer-text" id="timer-num">60</div></div>
        <div id="word-disp">PALAVRA</div>
        <div class="hud-bar"><div class="hud-left">â–¼ ACERTOU</div><div class="hud-right">â–² PULAR</div></div>
        <div class="touch-zone tz-l" onclick="game.act(true)"></div>
        <div class="touch-zone tz-r" onclick="game.act(false)"></div>
        <div id="fb-ok" class="flash" style="background: rgba(34, 197, 94, 0.9);">ACERTOU!</div>
        <div id="fb-no" class="flash" style="background: rgba(239, 68, 68, 0.9);">PULOU!</div>
    </div>

    <!-- TELA 5: RESULTADO -->
    <div id="screen-res" class="screen">
        <h2 style="color:var(--success); font-size: 4vh;">FIM DA RODADA</h2>
        <div id="res-score" style="font-size: 12vh; font-weight: 900; margin: 2vh 0;">0</div>
        <div id="res-list" style="width:100%; max-width:600px; height:30vh; overflow-y:auto; background:rgba(255,255,255,0.1); border-radius:15px; padding:15px;"></div>
        <button class="btn" style="width:auto; margin-top:3vh" onclick="app.next()">PRÃ“XIMO</button>
    </div>

    <!-- TELA 6: FINAL -->
    <div id="screen-final" class="screen">
        <h1 style="font-size: 8vh;">FIM DE JOGO</h1>
        <div style="display:flex; gap:4vw; margin: 4vh 0; flex-wrap: wrap; justify-content: center;">
            <div style="text-align:center; background:rgba(255,255,255,0.1); padding:3vh; border-radius:20px; min-width:20vw">
                <div id="fn-1" style="color:#818cf8; font-weight:bold; font-size: 3vh">Azul</div><div id="fs-1" style="font-size:8vh; font-weight:900">0</div>
            </div>
            <div style="text-align:center; background:rgba(255,255,255,0.1); padding:3vh; border-radius:20px; min-width:20vw">
                <div id="fn-2" style="color:#f472b6; font-weight:bold; font-size: 3vh">Rosa</div><div id="fs-2" style="font-size:8vh; font-weight:900">0</div>
            </div>
        </div>
        <h2 id="winner" style="color:var(--accent); font-size: 4vh;">VENCEDOR</h2>
        <button class="btn" style="width:auto; margin-top: 3vh;" onclick="location.reload()">MENU PRINCIPAL</button>
    </div>

    <!-- SHEET JS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <script>
        const COLORS = ["#ef4444", "#f97316", "#eab308", "#22c55e", "#06b6d4", "#3b82f6", "#8b5cf6", "#ec4899"];
        const DEFAULT_CATS = [
            {n:"ANIMAIS", w:["Gato","Cachorro","Elefante","Girafa","LeÃ£o","TubarÃ£o","Panda","Zebra","Macaco"]},
            {n:"FILMES", w:["Titanic","Avatar","Matrix","Shrek","Barbie","Batman","Frozen","Vingadores","Coringa"]},
            {n:"OBJETOS", w:["Mesa","Cadeira","Celular","Espelho","SofÃ¡","Copo","RelÃ³gio","Sapato","Computador"]},
            {n:"AÃ‡Ã•ES", w:["Correr","DanÃ§ar","Nadar","Dormir","Comer","Beijar","Gritar","Chorar","Pular"]},
            {n:"FAMOSOS", w:["Neymar","Anitta","Messi","BeyoncÃ©","Xuxa","PelÃ©","Madonna","Silvio Santos"]},
            {n:"LUGARES", w:["Praia","Escola","Shopping","Cinema","Hospital","Igreja","Parque","Banco"]}
        ];
        
        let GLOBAL_SHEETS_DATA = [ JSON.parse(JSON.stringify(DEFAULT_CATS)) ];
        let CURRENT_SHEET_IDX = 0;
        let SOURCE_TYPE = 'default';
        let CURRENT_ROUND_CATS = [];

        const aud = { p:(i)=>{document.getElementById('snd-'+i).play().catch(()=>{})}, l:(i,o)=>{const a=document.getElementById('snd-'+i); o?a.play().catch(()=>{}):a.pause()} };
        const st = { t:[{n:"",s:0,c:"#6366f1"},{n:"",s:0,c:"#ec4899"}], cfg:{t:60,r:3}, rd:1, trn:0, cat:null, q:[], skp:[], h:[], pts:0, on:false };

        /* UI UTILS */
        const ui = {
            modal: (title, html, actions) => {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-msg').innerHTML = html;
                const actionBox = document.getElementById('modal-actions');
                actionBox.innerHTML = '';
                actions.forEach(a => {
                    const btn = document.createElement('button');
                    btn.className = a.cls || 'btn btn-small';
                    btn.innerText = a.txt;
                    btn.onclick = () => {
                        if(a.close !== false) document.getElementById('modal-overlay').style.display = 'none';
                        if(a.fn) a.fn();
                    };
                    actionBox.appendChild(btn);
                });
                document.getElementById('modal-overlay').style.display = 'flex';
            },
            alert: (msg) => { ui.modal("AtenÃ§Ã£o", msg, [{txt:"OK"}]); },
            confirm: (msg, cb) => { ui.modal("ConfirmaÃ§Ã£o", msg, [{txt:"Sim", fn:cb}, {txt:"NÃ£o", cls:'btn btn-small btn-outline'}]); },
            showResult: (catName, catColor, cb) => {
                const html = `<div id="result-cat-display" style="color:${catColor}; font-size:2.5rem; font-weight:900; text-transform:uppercase; line-height:1.1; margin-bottom:20px">${catName}</div>`;
                ui.modal("CATEGORIA", html, [{txt:"COMEÃ‡AR", fn:cb}]);
            }
        };

        function smartSplit(text) {
            const clean = text.replace(/\*$/, '');
            if (clean.length <= 12) return { text: clean, lines: 1 };
            const words = clean.split(' ');
            if (words.length === 1) return { text: clean, lines: 1 };
            let best=0, min=Infinity, cur=0, tot=clean.length;
            for(let i=0; i<words.length-1; i++) { cur+=words[i].length; const d=Math.abs(cur-(tot-cur)); if(d<min){min=d; best=i;} }
            return { text: `${words.slice(0, best+1).join(' ')}<br>${words.slice(best+1).join(' ')}`, lines: 2, maxLen: Math.max(words.slice(0, best+1).join(' ').length, words.slice(best+1).join(' ').length) };
        }

        /* STORAGE & DATA */
        const storage = {
            save: () => {
                const data = {
                    cats: GLOBAL_SHEETS_DATA, source: SOURCE_TYPE,
                    t1: document.getElementById('t1').value, t2: document.getElementById('t2').value,
                    time: document.getElementById('opt-time').value, rounds: document.getElementById('opt-rounds').value,
                    mode: document.getElementById('opt-mode').value,
                    threshold: document.getElementById('opt-threshold').value
                };
                localStorage.setItem('pnt_data_v22', JSON.stringify(data));
            },
            load: () => {
                try {
                    const data = JSON.parse(localStorage.getItem('pnt_data_v22'));
                    if(data) {
                        if(data.cats && Array.isArray(data.cats)) {
                            if(data.cats.length > 0 && Array.isArray(data.cats[0])) {
                                GLOBAL_SHEETS_DATA = data.cats;
                            } else {
                                GLOBAL_SHEETS_DATA = [data.cats];
                            }
                        }
                        
                        if(data.source) SOURCE_TYPE = data.source;
                        if(data.t1) document.getElementById('t1').value = data.t1;
                        if(data.t2) document.getElementById('t2').value = data.t2;
                        if(data.time) document.getElementById('opt-time').value = data.time;
                        if(data.rounds) document.getElementById('opt-rounds').value = data.rounds;
                        if(data.mode) document.getElementById('opt-mode').value = data.mode;
                        if(data.threshold) document.getElementById('opt-threshold').value = data.threshold;
                        app.toggleThresholdVisibility();
                    }
                } catch(e) { localStorage.removeItem('pnt_data_v22'); }
            }
        };

        const dataMgr = {
            isTableMode: true,
            init: () => { 
                if (CURRENT_SHEET_IDX >= GLOBAL_SHEETS_DATA.length) CURRENT_SHEET_IDX = 0;
                dataMgr.updateSheetSelector();
                document.getElementById('json-input').value = JSON.stringify(GLOBAL_SHEETS_DATA[CURRENT_SHEET_IDX], null, 2); 
                dataMgr.renderTable();
            },
            updateSheetSelector: () => {
                const sel = document.getElementById('sheet-selector');
                sel.innerHTML = '';
                GLOBAL_SHEETS_DATA.forEach((s, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = `Aba ${i+1} (${s.length} cats)`;
                    if(i === parseInt(CURRENT_SHEET_IDX)) opt.selected = true;
                    sel.appendChild(opt);
                });
            },
            switchSheet: (idx) => {
                if(dataMgr.isTableMode) dataMgr.syncFromTable(); else dataMgr.syncFromJSON();
                CURRENT_SHEET_IDX = parseInt(idx);
                dataMgr.init();
            },
            toggleView: () => {
                dataMgr.isTableMode = !dataMgr.isTableMode;
                document.getElementById('btn-toggle-view').innerText = dataMgr.isTableMode ? "Ver JSON" : "Ver Tabela";
                document.getElementById('view-json').classList.toggle('active', !dataMgr.isTableMode);
                document.getElementById('view-table').classList.toggle('active', dataMgr.isTableMode);
                if(dataMgr.isTableMode) dataMgr.syncFromJSON(); else dataMgr.syncFromTable();
            },
            markDirty: () => {},
            syncFromJSON: () => { try { GLOBAL_SHEETS_DATA[CURRENT_SHEET_IDX] = JSON.parse(document.getElementById('json-input').value); dataMgr.renderTable(); dataMgr.updateSheetSelector(); } catch(e) {} },
            syncFromTable: () => {
                const rows = document.querySelectorAll('.table-row'); const newCats = [];
                rows.forEach(r => {
                    const n = r.querySelector('.table-input-cat').value; const wStr = r.querySelector('.table-input-words').value;
                    if(n && wStr) { const w = wStr.split(',').map(s=>s.trim()).filter(s=>s); if(w.length) newCats.push({n, w}); }
                });
                GLOBAL_SHEETS_DATA[CURRENT_SHEET_IDX] = newCats; document.getElementById('json-input').value = JSON.stringify(GLOBAL_SHEETS_DATA[CURRENT_SHEET_IDX], null, 2);
                dataMgr.updateSheetSelector();
            },
            renderTable: () => {
                const container = document.getElementById('table-rows'); container.innerHTML = '';
                const currentData = GLOBAL_SHEETS_DATA[CURRENT_SHEET_IDX] || [];
                currentData.forEach((cat, idx) => {
                    const row = document.createElement('div'); row.className = 'table-row';
                    row.innerHTML = `<input type="text" class="table-input-cat" value="${cat.n}" placeholder="Categoria"><input type="text" class="table-input-words" value="${cat.w.join(', ')}" placeholder="Palavras"><button class="btn btn-del" onclick="this.parentElement.remove()">Ã—</button>`;
                    container.appendChild(row);
                });
            },
            addTableRow: () => {
                const container = document.getElementById('table-rows'); const row = document.createElement('div'); row.className = 'table-row';
                row.innerHTML = `<input type="text" class="table-input-cat" placeholder="NOVA"><input type="text" class="table-input-words" placeholder="A, B, C..."><button class="btn btn-del" onclick="this.parentElement.remove()">Ã—</button>`;
                container.appendChild(row);
            },
            save: () => {
                if(dataMgr.isTableMode) dataMgr.syncFromTable(); else dataMgr.syncFromJSON();
                SOURCE_TYPE='default'; storage.save(); ui.alert("Salvo com sucesso!");
            },
            reset: () => { ui.confirm("Resetar tudo para o padrÃ£o?", ()=>{ GLOBAL_SHEETS_DATA = [JSON.parse(JSON.stringify(DEFAULT_CATS))]; CURRENT_SHEET_IDX=0; SOURCE_TYPE='default'; dataMgr.init(); storage.save(); }); },
            copyPrompt: () => { navigator.clipboard.writeText("Gere JSON: [{\"n\":\"CAT\", \"w\":[\"A\",\"B\"]}]").then(()=>ui.alert("Prompt copiado!")); },
            loadDefault: () => {
                document.getElementById('sheet-input').value = "https://docs.google.com/spreadsheets/d/1adTHnrCTt5bEmFowjqjFaPng04cWF0sY5Xn6YdGtLDo/edit?usp=drivesdk";
                dataMgr.loadSheet();
            },
            loadSheet: async () => {
                const url = document.getElementById('sheet-input').value;
                if(!url) return;
                try {
                    let exportUrl = url;
                    if (url.includes('docs.google.com/spreadsheets')) {
                         const id = url.match(/\/d\/(.*?)\//)[1];
                         exportUrl = `https://docs.google.com/spreadsheets/d/${id}/export?format=xlsx`;
                    }
                    const response = await fetch(exportUrl);
                    if (!response.ok) throw new Error("Network");
                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const parsedSheets = [];
                        workbook.SheetNames.forEach(sheetName => {
                            const sheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
                            const cats = [];
                            if (json.length > 0) {
                                const headers = json[0];
                                for (let c = 0; c < headers.length; c++) {
                                    const name = headers[c]; if (!name) continue;
                                    const words = [];
                                    for (let r = 1; r < json.length; r++) { if (json[r] && json[r][c]) words.push(String(json[r][c]).trim()); }
                                    if (words.length > 0) cats.push({n: name, w: words});
                                }
                            }
                            if (cats.length > 0) parsedSheets.push(cats);
                        });
                        if (parsedSheets.length > 0) {
                            GLOBAL_SHEETS_DATA = parsedSheets; SOURCE_TYPE = 'sheets';
                            CURRENT_SHEET_IDX = 0;
                            dataMgr.init(); storage.save(); ui.alert(`Sucesso! ${parsedSheets.length} abas carregadas.`);
                        } else { ui.alert("Nenhuma categoria encontrada."); }
                    };
                    reader.readAsArrayBuffer(blob);
                } catch(e) { ui.alert("Erro ao ler planilha."); }
            }
        };

        /* SENSOR (HISTERESE) */
        const sensor = {
            z: 0, wait: false,
            resetState: true, 
            init: () => { if (window.DeviceMotionEvent) window.addEventListener('devicemotion', sensor.handle); },
            handle: (e) => {
                const acc = e.accelerationIncludingGravity; if (!acc) return;
                sensor.z = acc.z || 0;
                if (st.on && !sensor.wait) {
                    if (sensor.resetState) {
                        if (sensor.z < -8.0) { 
                            game.act(true); 
                            sensor.pause(); 
                            sensor.resetState = false;
                        } else if (sensor.z > 8.0) { 
                            game.act(false); 
                            sensor.pause(); 
                            sensor.resetState = false; 
                        }
                    } else {
                        if (Math.abs(sensor.z) < 2.0) sensor.resetState = true;
                    }
                }
            },
            pause: () => { sensor.wait = true; setTimeout(() => sensor.wait = false, 1500); }
        };
        sensor.init();

        /* NAV */
        const app = {
            to: (id) => {
                if(document.querySelector('#screen-game.active')) game.stop();
                document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
                document.getElementById('screen-'+id).classList.add('active');
                if(id === 'options') dataMgr.init();
                const homeBtn = document.getElementById('home-btn');
                
                // RESET DO TIMER E RODADA AO VOLTAR PARA HOME
                if(id === 'home') {
                    homeBtn.style.display = 'none';
                    game.stop();
                    document.getElementById('timer-num').innerText = st.cfg.t;
                    document.querySelector('.timer-wrapper').style.background = `conic-gradient(var(--secondary) 0deg, #333 0deg)`;
                    
                    // RESET LÃ“GICO COMPLETO
                    st.rd = 1;
                    st.trn = 0;
                    st.pts = 0;
                    st.t[0].s = 0;
                    st.t[1].s = 0;
                } else {
                    homeBtn.style.display = 'block';
                }
            },
            tryHome: () => { ui.confirm("Voltar ao menu?", () => { app.to('home'); }); },
            toggleThresholdVisibility: () => {
                const mode = document.getElementById('opt-mode').value;
                const el = document.getElementById('group-threshold');
                if(mode === 'auto') el.style.display = 'block'; else el.style.display = 'none';
            },
            confirmTeams: () => {
                try {
                    st.t[0].n = document.getElementById('t1').value || "Time 1";
                    st.t[1].n = document.getElementById('t2').value || "Time 2";
                    st.cfg.t = parseInt(document.getElementById('opt-time').value) || 60;
                    st.cfg.r = parseInt(document.getElementById('opt-rounds').value) || 3;
                    storage.save();
                    app.prep();
                } catch(e) {
                    ui.alert("Erro ao iniciar. Reiniciando...");
                    localStorage.clear();
                    location.reload();
                }
            },
            start: () => {
                try {
                    aud.p('click');
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen().catch(()=>{});
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen();
                    }
                    
                    if(!GLOBAL_SHEETS_DATA || GLOBAL_SHEETS_DATA.length === 0) {
                         GLOBAL_SHEETS_DATA = [JSON.parse(JSON.stringify(DEFAULT_CATS))];
                    }
                    
                    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') { 
                        DeviceMotionEvent.requestPermission().catch(()=>{}); 
                    }
                    
                    st.t[0].n = document.getElementById('t1').value || "Time 1";
                    st.t[1].n = document.getElementById('t2').value || "Time 2";
                    st.cfg.t = parseInt(document.getElementById('opt-time').value) || 60;
                    st.cfg.r = parseInt(document.getElementById('opt-rounds').value) || 3;
                    
                    storage.save();
                    app.to('teams');
                } catch(e) {
                    localStorage.removeItem('pnt_data_v22');
                    location.reload();
                }
            },
            prep: () => {
                if(st.rd > st.cfg.r) { app.end(); return; }
                const turnIdx = (st.rd - 1) * 2 + st.trn;
                const numSheets = GLOBAL_SHEETS_DATA.length;
                let effectiveSheets = numSheets;
                if (numSheets > 1 && numSheets % 2 !== 0) effectiveSheets = numSheets - 1;
                const sheetIdx = turnIdx % effectiveSheets;
                CURRENT_ROUND_CATS = GLOBAL_SHEETS_DATA[sheetIdx];
                const t = st.t[st.trn];
                document.getElementById('lbl-rd').innerText = st.rd;
                document.getElementById('lbl-tm').innerText = t.n;
                document.getElementById('lbl-tm').style.color = t.c;
                app.to('intro');
            },
            toWheel: () => { aud.p('click'); wheel.init(); app.to('wheel'); },
            next: () => { aud.p('click'); st.trn++; if(st.trn>1){st.trn=0; st.rd++} app.prep(); },
            end: () => {
                const t1=st.t[0], t2=st.t[1];
                document.getElementById('fn-1').innerText=t1.n; document.getElementById('fs-1').innerText=t1.s;
                document.getElementById('fn-2').innerText=t2.n; document.getElementById('fs-2').innerText=t2.s;
                const w=document.getElementById('winner');
                if(t1.s>t2.s) {w.innerText=t1.n+" VENCEU!"; w.style.color=t1.c;}
                else if(t2.s>t1.s) {w.innerText=t2.n+" VENCEU!"; w.style.color=t2.c;}
                else {w.innerText="EMPATE"; w.style.color="white";}
                aud.p('win'); app.to('final');
            }
        };

        /* WHEEL & JACKPOT (PHYSICS & MATH FIX) */
        const wheel = {
            el: document.getElementById('wheel-spinner'),
            jackpot: document.getElementById('jackpot-strip'),
            mode: 'wheel',
            ang: 0, offsetY: 0, spin: false, velocity: 0, lastVal: 0, lastTime: 0,
            
            init: () => {
                // LÃ“GICA ALTERADA PARA RESPEITAR OPÃ‡Ã•ES
                const mode = document.getElementById('opt-mode').value;
                const thresh = parseInt(document.getElementById('opt-threshold').value) || 12;

                if (mode === 'wheel') wheel.mode = 'wheel';
                else if (mode === 'jackpot') wheel.mode = 'jackpot';
                else {
                    // auto
                    wheel.mode = CURRENT_ROUND_CATS.length > thresh ? 'jackpot' : 'wheel';
                }

                document.getElementById('wheel-container').style.display = wheel.mode === 'wheel' ? 'block' : 'none';
                document.getElementById('jackpot-container').style.display = wheel.mode === 'jackpot' ? 'block' : 'none';
                wheel.spin = false;

                if (wheel.mode === 'wheel') wheel.setupWheel();
                else wheel.setupJackpot();
                
                const target = wheel.mode === 'wheel' ? document.getElementById('wheel-container') : document.getElementById('jackpot-container');
                const newEl = target.cloneNode(true);
                target.parentNode.replaceChild(newEl, target);
                
                if(wheel.mode==='wheel') wheel.el = document.getElementById('wheel-spinner');
                else wheel.jackpot = document.getElementById('jackpot-strip');
                
                wheel.attachPhysics(document.getElementById(wheel.mode === 'wheel' ? 'wheel-container' : 'jackpot-container'));
            },

            setupWheel: () => {
                let g="conic-gradient(", h=""; const count = CURRENT_ROUND_CATS.length; const sliceDeg = 360 / count;
                CURRENT_ROUND_CATS.forEach((c, i) => {
                    const color = COLORS[i % COLORS.length];
                    const start = i * sliceDeg; const end = (i + 1) * sliceDeg;
                    g += `${color} ${start}deg ${end}deg,`;
                    const mid = start + (sliceDeg / 2);
                    const split = smartSplit(c.n);
                    let fontSize = 4; const refLen = split.lines === 1 ? c.n.length : split.maxLen;
                    if(refLen > 8) fontSize = 4 * (8 / refLen);
                    h += `<div class="slice-wrapper" style="transform:rotate(${mid - 90}deg)"><span class="slice-text" style="font-size:${fontSize}vh">${split.text}</span></div>`;
                });
                wheel.el.style.background = g.slice(0, -1) + ")"; wheel.el.innerHTML = h;
                wheel.el.style.transform = `rotate(0deg)`;
            },

            setupJackpot: () => {
                let h = "";
                const list = [...CURRENT_ROUND_CATS, ...CURRENT_ROUND_CATS, ...CURRENT_ROUND_CATS]; 
                const n = CURRENT_ROUND_CATS.length;
                list.forEach((c, i) => {
                     // FIX COR: Usa o Ã­ndice original para garantir consistÃªncia da cor
                     const realIndex = i % n;
                     const color = COLORS[realIndex % COLORS.length];
                     h += `<div class="jackpot-item" style="background:${color}">${c.n.replace('*','')}</div>`;
                });
                wheel.jackpot.innerHTML = h;
                wheel.offsetY = 0; wheel.jackpot.style.transform = `translateY(0px)`;
            },

            attachPhysics: (target) => {
                const track = (e) => {
                    const now = Date.now();
                    let currentVal, delta;
                    if (wheel.mode === 'wheel') {
                        const rect = target.getBoundingClientRect();
                        const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2;
                        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                        const angleDeg = Math.atan2(clientY - cy, clientX - cx) * (180 / Math.PI);
                        if (wheel.lastVal !== null) {
                            delta = angleDeg - wheel.lastVal;
                            if (delta > 180) delta -= 360; if (delta < -180) delta += 360;
                            wheel.ang += delta;
                            wheel.el.style.transform = `rotate(${wheel.ang}deg)`;
                        }
                        currentVal = angleDeg;
                    } else {
                        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                        currentVal = clientY;
                        if (wheel.lastVal !== null) {
                            delta = currentVal - wheel.lastVal;
                            wheel.offsetY += delta;
                            wheel.jackpot.style.transform = `translateY(${wheel.offsetY}px)`;
                        }
                    }
                    const dt = now - wheel.lastTime;
                    if(dt > 0 && delta !== undefined) { wheel.velocity = (delta / dt) * 15; if (wheel.mode === 'jackpot') wheel.velocity *= 1.5; }
                    wheel.lastVal = currentVal; wheel.lastTime = now;
                };
                const start = (e) => {
                    if(wheel.spin) return;
                    wheel.lastVal = null; wheel.lastTime = Date.now(); wheel.velocity = 0;
                    if (wheel.mode === 'wheel') { 
                        const rect = target.getBoundingClientRect();
                        const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2;
                        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                        wheel.lastVal = Math.atan2(clientY - cy, clientX - cx) * (180 / Math.PI);
                    } else { wheel.lastVal = e.touches ? e.touches[0].clientY : e.clientY; }
                    document.addEventListener('touchmove', onMove, {passive: false});
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('touchend', onEnd);
                    document.addEventListener('mouseup', onEnd);
                };
                const onMove = (e) => { e.preventDefault(); track(e); };
                const onEnd = () => {
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('touchend', onEnd);
                    document.removeEventListener('mouseup', onEnd);
                    if(Math.abs(wheel.velocity) > 0.5) wheel.go(wheel.velocity);
                };
                target.onmousedown = start; target.ontouchstart = start;
            },

            go: (v) => {
                wheel.spin=true; aud.l('spin',true);
                let vel = v; if(vel>50) vel=50; if(vel<-50) vel=-50;
                let winnerIdx = -1;

                // CHECK DO CHEAT (*) AQUI
                const cheats = CURRENT_ROUND_CATS.map((c,i) => c.n.endsWith('*') ? i : -1).filter(i => i !== -1);
                if (cheats.length > 0) winnerIdx = cheats[Math.floor(Math.random() * cheats.length)];

                const loop=()=>{
                    if(!wheel.spin) return;
                    vel *= 0.985; // Friction
                    
                    if (wheel.mode === 'wheel') {
                         wheel.ang += vel; wheel.el.style.transform = `rotate(${wheel.ang}deg)`;
                    } else {
                         wheel.offsetY += vel * 5;
                         // PIXEL PERFECT HEIGHT
                         const itemEl = wheel.jackpot.querySelector('.jackpot-item');
                         const stripH = (itemEl ? itemEl.offsetHeight : 100) * CURRENT_ROUND_CATS.length; 
                         
                         if (wheel.offsetY > 0) wheel.offsetY -= stripH;
                         if (wheel.offsetY < -stripH * 2) wheel.offsetY += stripH;
                         wheel.jackpot.style.transform = `translateY(${wheel.offsetY}px)`;
                    }

                    // SMOOTH STOP (THRESHOLD INCREASED TO 0.5)
                    if(Math.abs(vel) < 0.5) {
                         wheel.spin = false;
                         
                         // FORCE CHEAT IF EXISTS
                         if (winnerIdx !== -1) {
                             wheel.snapToWinner(winnerIdx);
                         } else {
                             // NATURAL STOP & CALC
                             wheel.calcWinner();
                         }
                    } else {
                         requestAnimationFrame(loop);
                    }
                }
                loop();
            },

            snapToWinner: (idx) => {
                if (wheel.mode === 'wheel') {
                    const sliceDeg = 360 / CURRENT_ROUND_CATS.length;
                    
                    // Current Rotation
                    const cur = wheel.ang;
                    
                    // Target Angle calculation (normalized)
                    // We want the slice `idx` to be at the top (270deg visually in CSS, but 0 in logic)
                    // The logic `(360 - norm) % 360` inverse mapping suggests:
                    // Target rotation = -idx * sliceDeg
                    
                    // Let's find the closest multiple of 360 to the current angle to minimize spin
                    const targetBase = -(idx * sliceDeg) - (sliceDeg/2);
                    
                    // Normalize current angle
                    const currentMod = cur % 360;
                    const diff = targetBase - currentMod;
                    
                    // Find shortest path
                    let delta = diff;
                    if (delta > 180) delta -= 360;
                    if (delta < -180) delta += 360;
                    
                    const finalAngle = cur + delta;

                    wheel.el.style.transition = "transform 1.5s cubic-bezier(0.1, 0, 0.2, 1)";
                    wheel.el.style.transform = `rotate(${finalAngle}deg)`;
                    setTimeout(() => wheel.finish(idx), 1500);
                } else {
                    // PIXEL PERFECT CALCULATION (FIX FOR IOS)
                    const itemEl = wheel.jackpot.querySelector('.jackpot-item');
                    const itemH = itemEl ? itemEl.offsetHeight : 100;
                    const centerLine = wheel.jackpot.offsetHeight / 2;
                    
                    // We have 3 sets. We are somewhere in the negative Y.
                    // Current Y
                    const currentY = wheel.offsetY;
                    
                    // The positions of the winner index in the 3 sets:
                    // Set 0: index
                    // Set 1: index + N
                    // Set 2: index + 2N
                    const n = CURRENT_ROUND_CATS.length;
                    const candidates = [idx, idx + n, idx + 2*n];
                    
                    let bestY = currentY;
                    let minDiff = Infinity;
                    
                    // Find the Y position that places this candidate in the center
                    // Y + (cand * H) + H/2 = Center
                    // Y = Center - (cand * H) - H/2
                    
                    candidates.forEach(cIdx => {
                        const targetY = centerLine - (cIdx * itemH) - (itemH/2);
                        const diff = Math.abs(targetY - currentY);
                        if(diff < minDiff) {
                            minDiff = diff;
                            bestY = targetY;
                        }
                    });
                    
                    wheel.jackpot.style.transition = "transform 1.5s cubic-bezier(0.1, 0, 0.2, 1)";
                    wheel.jackpot.style.transform = `translateY(${bestY}px)`;
                    setTimeout(() => wheel.finish(idx), 1500);
                }
            },

            calcWinner: () => {
                let idx;
                if (wheel.mode === 'wheel') {
                    const norm = (wheel.ang % 360 + 360) % 360;
                    const winAngle = (360 - norm) % 360;
                    const sliceDeg = 360 / CURRENT_ROUND_CATS.length;
                    idx = Math.floor(winAngle / sliceDeg);
                    // Just visual snap
                    // Recalculate perfect center
                    const targetAngle = wheel.ang + (sliceDeg/2 - (wheel.ang % sliceDeg)); // Rough snap
                    // Actually, we can just let it be, or do a small snap. 
                    // For simplicity, we just wait.
                } else {
                    // PIXEL PERFECT CALCULATION
                    const itemEl = wheel.jackpot.querySelector('.jackpot-item');
                    const itemH = itemEl ? itemEl.offsetHeight : 100;
                    const centerLine = wheel.jackpot.offsetHeight / 2;
                    
                    const relativeY = centerLine - (itemH/2) - wheel.offsetY;
                    let rawIndex = Math.round(relativeY / itemH);
                    
                    const targetY = -(rawIndex * itemH) + centerLine - (itemH/2);
                    
                    wheel.jackpot.style.transition = "transform 0.5s ease-out";
                    wheel.jackpot.style.transform = `translateY(${targetY}px)`;
                    
                    const n = CURRENT_ROUND_CATS.length;
                    idx = ((rawIndex % n) + n) % n;
                }
                // Add slight delay for visual snap
                setTimeout(() => wheel.finish(idx), 500);
            },

            finish: (idx) => {
                aud.l('spin', false); aud.p('win');
                const cat = CURRENT_ROUND_CATS[idx];
                
                st.cat = cat; 

                // FIX COLOR: Mesma lÃ³gica do setup para garantir cor correta no modal
                const color = COLORS[(idx % CURRENT_ROUND_CATS.length) % COLORS.length];

                ui.showResult(cat.n.replace('*', ''), color, () => game.pre());
                
                // Reset transition for next drag
                setTimeout(() => {
                    if (wheel.mode === 'wheel') wheel.el.style.transition = 'none';
                    else wheel.jackpot.style.transition = 'none';
                }, 100);
            }
        };

        /* GAME */
        const game = {
            tmr: null,
            stop: () => { if(game.tmr) clearInterval(game.tmr); },
            pre: () => {
                app.to('game'); 
                document.getElementById('timer-num').innerText = st.cfg.t;
                document.querySelector('.timer-wrapper').style.background = `conic-gradient(var(--secondary) 0deg, var(--secondary) 360deg)`;
                const d=document.getElementById('word-disp'); 
                let c=3; d.innerText=c; 
                const i=setInterval(()=>{ c--; if(c>0) d.innerText=c; else { clearInterval(i); d.innerText="VAI!"; setTimeout(game.run, 600); } },1000);
            },
            run: () => {
                game.stop(); 
                st.on=true; st.pts=0; st.h=[]; st.skp=[]; st.q = [...st.cat.w].sort(()=>Math.random()-0.5);
                game.next();
                let totalT=st.cfg.t; let t=totalT;
                const tn=document.getElementById('timer-num'); const tw=document.querySelector('.timer-wrapper');
                game.tmr = setInterval(()=>{
                    t--; tn.innerText=t;
                    const pct=((totalT-t)/totalT)*360;
                    tw.style.background=`conic-gradient(var(--secondary) ${pct}deg, #333 ${pct}deg)`;
                    if(t<=0) { game.stop(); game.end(); }
                },1000);
            },
            next: () => {
                if(st.q.length === 0) {
                    if(st.skp.length > 0) { st.q = [...st.skp].sort(()=>Math.random()-0.5); st.skp = []; } 
                    else { game.stop(); game.end(); return; }
                }
                st.cw = st.q.pop(); document.getElementById('word-disp').innerText = st.cw;
            },
            act: (win) => {
                if(!st.on) return;
                if(win){ aud.p('ok'); st.pts++; st.h.push({w:st.cw,ok:true}); game.flash('fb-ok'); }
                else { aud.p('pass'); st.h.push({w:st.cw,ok:false}); game.flash('fb-no'); st.skp.push(st.cw); }
                game.next();
            },
            flash: (id) => { const e=document.getElementById(id); e.style.opacity=1; setTimeout(()=>e.style.opacity=0,600); },
            end: () => {
                st.on=false; game.stop();
                st.t[st.trn].s += st.pts; document.getElementById('res-score').innerText=st.pts;
                const l=document.getElementById('res-list'); l.innerHTML="";
                st.h.forEach(x=>{
                    const d=document.createElement('div');
                    d.innerHTML=`<b style="color:${x.ok?'#22c55e':'#ef4444'}">${x.ok?'âœ“':'âœ—'}</b> ${x.w}`;
                    d.style.padding="10px"; d.style.borderBottom="1px solid rgba(255,255,255,0.1)"; l.appendChild(d);
                });
                app.to('res');
            }
        };

        window.onload = () => {
            storage.load();
            sensor.init();
        };
    </script>
</body>
</html>